name: Notificar a Discord

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, closed, reopened, synchronize]
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: PUSH ➜ Discord
        if: ${{ github.event_name == 'push' }}
        run: |
          short="${GITHUB_SHA::7}"
          repo="${GITHUB_REPOSITORY}"
          actor="${GITHUB_ACTOR}"
          msg="${{ github.event.head_commit.message }}"
          url="https://github.com/${repo}/commit/${GITHUB_SHA}"
          payload=$(printf '{"username":"GitHub Bot","content":"📦 **Push** en %s por %s\n`%s` - %s\n<%s>"}' "$repo" "$actor" "$short" "$msg" "$url")
          curl -sS -H "Content-Type: application/json" -d "$payload" "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: PR ➜ Discord
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          title='${{ github.event.pull_request.title }}'
          number='${{ github.event.pull_request.number }}'
          action='${{ github.event.action }}'
          url='${{ github.event.pull_request.html_url }}'
          author='${{ github.event.pull_request.user.login }}'
          payload=$(jq -n --arg t "$title" --arg n "$number" --arg a "$action" --arg u "$url" --arg au "$author" \
            '{username:"GitHub Bot", embeds:[{title:"🔀 Pull Request #\($n)", description:$t, url:$u, fields:[{name:"Acción",value:$a,inline:true},{name:"Autor",value:$au,inline:true}]}]}')
          curl -sS -H "Content-Type: application/json" -d "$payload" "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: RELEASE ➜ Discord
        if: ${{ github.event_name == 'release' && github.event.action == 'published' }}
        run: |
          tag='${{ github.event.release.tag_name }}'
          name='${{ github.event.release.name }}'
          url='${{ github.event.release.html_url }}'
          notes='${{ github.event.release.body || 'Sin notas' }}'
          payload=$(jq -n --arg tag "$tag" --arg name "$name" --arg url "$url" --arg notes "$notes" \
            '{username:"GitHub Bot", embeds:[{title:"🏷️ Nueva release: \($tag)", description:$name, url:$url, fields:[{name:"Notas", value:( $notes | if (.|length)>1024 then (.[:1021] + "...") else . end)}]}]}')
          curl -sS -H "Content-Type: application/json" -d "$payload" "${{ secrets.DISCORD_WEBHOOK_URL }}"
